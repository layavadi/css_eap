This program processes PDF documents from a specified location, stores them in Cloudera Semantic Search (CSS) with vector embeddings, and allows users to query the data using a pre-trained language model. CSS handles the search and retrieval process, while Azure OpenAI generates responses based on the retrieved context. The embeddings are generated by an externally hosted model in Cloudera Machine Learning (CML) inferencing engine. CSS Machine Leanearing Tool agent is used to integrate vector search for context and interacting with LLM in Azure OpenAI model for answers. In this demo only user query is sent to the CSS and through the ML Tool infrastructure , CSS fetches the vectors semantically close to question that was asked, fetches the context and sends the prompt to the LLM hosted externally with out having to do any processing at the client site. For the subsequent questions, it uses previous history with CSS memory API and sends the question along with history to the LLM. 

- **This demo needs nodes having following roles**
    - data
    - ingest
    - ml


## Requirements
- **Python 3.8+**
- **Cloudera Semantic Search**  server with endpoints 
- **Azure OpenAI** credentials for query processing with the LLM
- **Cloudera AI** Embedding Model endpoint with CDP Token to connect to 
- **CSS Config** Need to disable plugin security by setting `plugins.security.disabled: true` in `opensearch.yml`. This demo currently runls only with 2.17.x version 

## Environment Variables
Set the following environment variables in your shell or `.env` file before running the program.

- **CSS Connection**  
  - `CSS_HOST`: Host address of the Cloudera Semantic Search server (default: `localhost`)
  - `CSS_PORT`: Port of the OpenSearch server (default: `9200`)
  - `CSS_USER`: Username for OpenSearch authentication
  - `CSS_PASSWORD`: Password for OpenSearch authentication
  - `DATA_FILE_PATH`: PDF files to load (default: `./data`)
  - `CSS_OPENAI_KEY`: Azure OpenAI key 
  - `CSS_OPENAI_VERSION` : OpenAI model version
  - `CSS_OPENAI_MODEL` : OpenAI model for LLM Chat
  - `CSS_OPENAI_ENDPOINT` : OpenAI model servicing Endpoint (For ex cldr-search.openai.azure.com )
  - `CSS_SSL`:  True if SSL is enabled for CSS connection
  - `CSS_EMBEDDING_OPENAI_KEY`:  This is the CDP_TOKEN obtained through cdp cli for the enviroment running CML model 
  - `CSS_EMBEDDING_OPENAI_ENDPOINT`: CML Model endpoint URL obtained from CML Model UI for generating embeddings ( For ex: caii-prod-long-running.eng-ml-l.vnu8-sqze.cloudera.site/namespaces/serving-default/endpoints/mistral-7b-embedding-onnx/v1/embeddings )
  - `CSS_EMBEDDING_OPENAI_MODEL`: Model id of the CML Model deployed,
  - `CSS_EMBEDDING_DIMENSION` : Dimension of the vector embedding generated by the CML Model. 
  

2. **Install Dependencies**:
   Install the necessary packages by running:
   ```bash
   pip3 install -r session-install-deps/requirements.txt
   ```

## Running the Program
1. **Start the OpenSearch Server**:
   Ensure your Cloudera Semantic search  server is running and accessible at the host and port specified in the environment variables.

2. **Run the Script**:
   Start the following job for loading the data:
   ```python
   python css_load.py 
   ```
   This will:
   - Connect to CSS
   - Creates the conntector to externally hosted CML model serving endpoint
   - Creates the connector to externally hosted Azure OpenAI model 
   - Registers and deploys the emberdding and inferencing model with connector ID for generating embedding and generating answers respectively.
   - Registers the ML Tool referring to embedding and inferecing model for RAG use case. 
   - Creates the neural search pipleine referencing inferencing model for generating embeddings.
   - Creates index refering the neural search pipeline
   - Process and Chunk the  PDF documents from the specified directory. Currently there is one Cloudera Operationa Database document in the PDF format. One can add more to the same directory.
   - Ingest the chunks through neural search pipleine into the CSS vector store
   - Tests the query feature with a hard coded query invokign ML Tool for RAG

   Start the following Application for bringing up the search UI:
   ```python
   python search_app.py 
   ```

    RUn  the following Application to do cleanup of index , neural pipeline and model:
   ```python
   python clenaup.py 
   ```
   This will:
   - Connect to CSS
   - Deletes index, neural pipeline, undeploys and deletes the embedding models, connectors and ML Tool

## Usage
- **Querying the System**:
   - The Gradio UI provides an interface for users to enter a query. Upon submission, it:
     1. Converts the query into a vector and searches for similar document chunks in CSS through neural search feature of CSS.
     2. Feeds the retrieved context to Azure OpenAI to generate an answer.
     3. Displays the answer along with chunks  of  the original document chunks.
     4. Displays Index settings, mappings and neural pipeline definitions used.
     5. Displays the Embedding , inferencing Models.
     6. Display connectors for externally hosted models.
     7. Display the ML Tool definition.
     8. Display memory_id of the history.





